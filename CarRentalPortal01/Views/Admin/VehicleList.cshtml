@model IEnumerable<CarRentalPortal01.Models.Vehicle>

@{
    ViewData["Title"] = "Araç Listesi";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<style>
    div.dataTables_wrapper div.dataTables_filter {
        text-align: right;
    }
    .dataTables_wrapper {
        padding: 5px;
    }
    #VehicleList thead th {
        background-color: #f8f9fc;
        color: #4e73df;
        border-bottom: 2px solid #e3e6f0;
    }
</style>

<h1 class="h3 mb-2 text-gray-800">Araç Listesi</h1>
<p class="mb-4">Filodaki tüm araçların durumunu ve teknik detaylarını buradan yönetebilirsiniz.</p>

<div class="card shadow mb-4">
    <div class="card-header py-3">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">Kayıtlı Araçlar</h6>
            <a class="nav-link btn btn-primary btn-sm text-white" asp-controller="Admin" asp-action="Upsert">
                <i class="fas fa-fw fa-plus"></i>
                <span>Araç Ekle</span>
            </a>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered table-striped table-hover" id="VehicleList" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th style="width: 120px;">Görsel</th>
                        <th>Araç Bilgisi</th>
                        <th>Teknik Özellikler</th>  <th>KM</th>   <th>Plaka / Yıl</th>
                        <th>Fiyat (Günlük)</th>
                        <th>Durum</th>
                        <th style="width: 100px;">İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td>
                                <img src="/@item.ImageUrl" 
                                     width="100" height="70" 
                                     style="object-fit:cover; border-radius:5px; border:1px solid #ddd; cursor:pointer;" 
                                     alt="Araç Detayı"
                                     onclick="showVehicleDetails(@item.Id)" 
                                     title="Detaylar için tıklayın" />
                            </td>
                            
                            <td>
                                <div class="font-weight-bold text-primary" style="font-size: 1.1em;">@item.Brand @item.Model</div>
                                
                                @if (item.VehicleCategories != null && item.VehicleCategories.Any())
                                {
                                    foreach (var vc in item.VehicleCategories)
                                    {
                                        <span class="badge badge-secondary mt-1" style="font-weight: normal;">@vc.Category?.Name</span>
                                    }
                                }
                                else
                                {
                                    <span class="badge badge-light border mt-1 text-muted">Kategorisiz</span>
                                }
                            </td>

                            <td>
                                <div style="font-size: 0.9rem; line-height: 1.6;">
                                    <div>
                                        <i class="fas fa-gas-pump text-info mr-2" style="width:15px; text-align:center;"></i>
                                        @(string.IsNullOrEmpty(item.FuelType) ? "-" : item.FuelType)
                                    </div>
                                    <div>
                                        <i class="fas fa-cogs text-secondary mr-2" style="width:15px; text-align:center;"></i>
                                        @(string.IsNullOrEmpty(item.GearType) ? "-" : item.GearType)
                                    </div>
                                    <div>
                                        <i class="fas fa-palette text-warning mr-2" style="width:15px; text-align:center;"></i>
                                        @(string.IsNullOrEmpty(item.Color) ? "-" : item.Color)
                                    </div>
                                </div>
                            </td>

                            <td>
                                @if(item.Kilometer.HasValue)
                                {
                                    <span class="font-weight-bold">@item.Kilometer.Value.ToString("N0")</span> <small class="text-muted">km</small>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>

                            <td>
                                <div class="font-weight-bold text-dark border px-2 py-1 rounded bg-light d-inline-block">
                                    @item.LicensePlate
                                </div>
                                <div class="small text-muted mt-1 ml-1">
                                    <i class="fas fa-calendar-alt"></i> @item.Year Model
                                </div>
                            </td>

                            <td class="text-success font-weight-bold">
                                @item.DailyRentalRate.ToString("C0")
                            </td>
                            
                            <td>
                                @if (item.IsAvailable)
                                {
                                    <span class="badge badge-success p-2 w-100">Müsait</span>
                                }
                                else
                                {
                                    var activeMaintenance = item.Maintenances?.FirstOrDefault(m => !m.IsCompleted && m.StartDate <= DateTime.Now);
                            
                                    if (activeMaintenance != null)
                                    {
                                         <span class="badge badge-warning p-2 w-100 text-dark" title="@activeMaintenance.MaintenanceType">
                                            <i class="fas fa-tools"></i> Bakımda
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-danger p-2 w-100">
                                            <i class="fas fa-key"></i> Kirada
                                        </span>
                                    }
                                }
                            </td>                            
                            <td>
                                <div class="btn-group" role="group">
                                    <a asp-controller="Admin" asp-action="Upsert" asp-route-id="@item.Id" class="btn btn-warning btn-sm" title="Düzenle">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="javascript:void(0);" 
                                       class="btn btn-secondary btn-sm" 
                                       onclick="openMaintenanceModal(@item.Id)" 
                                       title="Bakıma Al">
                                        <i class="fas fa-tools"></i>
                                    </a>
                                    <a href="javascript:void(0);"
                                       class="btn btn-danger btn-sm"
                                       title="Sil"
                                       onclick="deleteVehicle('/Admin/Delete/@item.Id', '@item.Brand @item.Model')">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>
<div class="modal fade" id="detailModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content" id="detailModalContent">
            <div class="text-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Yükleniyor...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="maintenanceModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content" id="maintenanceModalContent">
            </div>
    </div>
</div>


@section Scripts {
    <script src="~/Admin/vendor/datatables/jquery.dataTables.min.js"></script>
    <script src="~/Admin/vendor/datatables/dataTables.bootstrap4.min.js"></script>

    <script>
        $(document).ready(function() {
            $('#VehicleList').DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.13.7/i18n/tr.json"
                },
                "order": [[0, "desc"]], 
                "lengthChange": true,   
                "searching": true,      
                "paging": true          
            });
        });

        // Silme İşlemi (SweetAlert)
        function deleteVehicle(url, modelName) {
            Swal.fire({
                title: 'Emin misiniz?',
                text: modelName + " silinecek!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Evet, Sil',
                cancelButtonText: 'İptal'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = url;
                }
            })
        }

        // Araç Detaylarını Getiren Fonksiyon (AJAX)
    function showVehicleDetails(id) {
        // Modalı aç
        $('#detailModal').modal('show');
        // İçini temizle ve yükleniyor koy
        $('#detailModalContent').html('<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div></div>');

        // Sunucudan veriyi iste
        $.ajax({
            url: '/Admin/GetVehicleDetails/' + id,
            type: 'GET',
            success: function(response) {
                // Gelen HTML'i modal içine bas
                $('#detailModalContent').html(response);
            },
            error: function() {
                $('#detailModalContent').html('<div class="alert alert-danger m-3">Veriler yüklenirken hata oluştu.</div>');
            }
        });
    }

    // Bakım Modalını Açan Fonksiyon
    function openMaintenanceModal(id) {
        $('#maintenanceModal').modal('show');
        $('#maintenanceModalContent').html('<div class="p-3 text-center"><div class="spinner-border text-warning"></div> Yükleniyor...</div>');

        $.ajax({
            url: '/Admin/AddMaintenance?vehicleId=' + id,
            type: 'GET',
            success: function (res) {
                $('#maintenanceModalContent').html(res);
            }
        });
    }

    // Bakımı Kaydeden Fonksiyon
    function saveMaintenance() {
        var formData = $('#maintenanceForm').serialize();

        $.ajax({
            url: '/Admin/AddMaintenance',
            type: 'POST',
            data: formData,
            success: function (res) {
                if (res.success) {
                    $('#maintenanceModal').modal('hide');
                    Swal.fire('Başarılı!', res.message, 'success').then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire('Hata!', 'Bir sorun oluştu.', 'error');
                }
            },
            error: function () {
                Swal.fire('Hata!', 'Sunucu hatası.', 'error');
            }
        });
    }

    </script>
}